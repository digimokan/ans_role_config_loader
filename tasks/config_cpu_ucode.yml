- name: "Determine CPU type (Intel/AMD), and set 'cpu_type' play fact"
  ansible.builtin.set_fact:
    cpu_type: "{{ 'amd' if amd_cpu|length > 0 else 'intel' if intel_cpu|length > 0 else 'unknown' }}"
  vars:
    intel_cpu: "{{ ansible_processor | select('match', 'Intel') | list }}"
    amd_cpu: "{{ ansible_processor | select('match', 'AMD') | list }}"

- name: "Abort role if CPU type not determined to be Intel or AMD"
  ansible.builtin.fail:
    msg: "CPU type not recognized as Intel or AMD"
  when: cpu_type == 'unknown'

- name: "Install 'devcpu-data' CPU microcode updates package"
  ansible.builtin.package:
    name: 'devcpu-data'
    state: present

- name: "Set cpu-microcode to load at boot in {{ loader_conf_path }}"
  community.general.sysrc:
    path: "{{ loader_conf_path }}"
    name: "cpu_microcode_load"
    value: "YES"
    state: present
  become: true
  become_user: root

- name: "Set cpu-microcode type to '{{ cpu_type }}' in {{ loader_conf_path }}"
  community.general.sysrc:
    path: "{{ loader_conf_path }}"
    name: "cpu_microcode_name"
    value: "/boot/firmware/{{ cpu_type }}-ucode.bin"
    state: present
  become: true
  become_user: root

